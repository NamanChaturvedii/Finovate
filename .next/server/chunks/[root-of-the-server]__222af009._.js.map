{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 132, "column": 0}, "map": {"version":3,"sources":["file:///D:/wealth/lib/inngest/client.js"],"sourcesContent":["import { Inngest } from \"inngest\";\r\n\r\nexport const inngest = new Inngest({\r\n  id: \"finance platform-ai\", // Unique app ID\r\n  name: \"Finance Platform-ai\",\r\n  retryFunction: async (attempt) => ({\r\n    delay: Math.pow(2, attempt) * 1000, // Exponential backoff\r\n    maxAttempts: 2,\r\n  }),\r\n});"],"names":[],"mappings":";;;AAAA;;AAEO,MAAM,UAAU,IAAI,kIAAA,CAAA,UAAO,CAAC;IACjC,IAAI;IACJ,MAAM;IACN,eAAe,OAAO,UAAY,CAAC;YACjC,OAAO,KAAK,GAAG,CAAC,GAAG,WAAW;YAC9B,aAAa;QACf,CAAC;AACH","debugId":null}},
    {"offset": {"line": 159, "column": 0}, "map": {"version":3,"sources":["file:///D:/wealth/lib/prisma.js"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\nexport const db = globalThis.prisma || new PrismaClient();\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  globalThis.prisma = db;\r\n}\r\n\r\n// the below explanation of above\r\n\r\n// globalThis.prisma: This global variable ensures that the Prisma client instance is\r\n// reused across hot reloads during development. Without this, each time your application\r\n// reloads, a new instance of the Prisma client would be created, potentially leading\r\n// to connection issues."],"names":[],"mappings":";;;AAAA;;AAEO,MAAM,KAAK,WAAW,MAAM,IAAI,IAAI,6HAAA,CAAA,eAAY;AAEvD,wCAA2C;IACzC,WAAW,MAAM,GAAG;AACtB,EAEA,iCAAiC;CAEjC,qFAAqF;CACrF,yFAAyF;CACzF,qFAAqF;CACrF,wBAAwB","debugId":null}},
    {"offset": {"line": 178, "column": 0}, "map": {"version":3,"sources":["file:///D:/wealth/emails/templates.jsx"],"sourcesContent":["import {\r\n    Body,\r\n    Container,\r\n    Head,\r\n    Heading,\r\n    Html,\r\n    Preview,\r\n    Section,\r\n    Text,\r\n} from \"@react-email/components\";\r\n\r\n// Dummy data for preview\r\n// const PREVIEW_DATA = {\r\n//     monthlyReport: {\r\n//         userName: \"John Doe\",\r\n//         type: \"monthly-report\",\r\n//         data: {\r\n//             month: \"December\",\r\n//             stats: {\r\n//                 totalIncome: 5000,\r\n//                 totalExpenses: 3500,\r\n//                 byCategory: {\r\n//                     housing: 1500,\r\n//                     groceries: 600,\r\n//                     transportation: 400,\r\n//                     entertainment: 300,\r\n//                     utilities: 700,\r\n//                 },\r\n//             },\r\n//             insights: [\r\n//                 \"Your housing expenses are 43% of your total spending - consider reviewing your housing costs.\",\r\n//                 \"Great job keeping entertainment expenses under control this month!\",\r\n//                 \"Setting up automatic savings could help you save 20% more of your income.\",\r\n//             ],\r\n//         },\r\n//     },\r\n//     budgetAlert: {\r\n//         userName: \"John Doe\",\r\n//         type: \"budget-alert\",\r\n//         data: {\r\n//             percentageUsed: 85,\r\n//             budgetAmount: 4000,\r\n//             totalExpenses: 3400,\r\n//         },\r\n//     },\r\n// };\r\n\r\nexport default function EmailTemplate({\r\n    userName = \"\",\r\n    type = \"monthly-report\",\r\n    data = {},\r\n}) {\r\n    if (type === \"monthly-report\") {\r\n        return (\r\n            <Html>\r\n                <Head />\r\n                <Preview>Your Monthly Financial Report</Preview>\r\n                <Body style={styles.body}>\r\n                    <Container style={styles.container}>\r\n                        <Heading style={styles.title}>Monthly Financial Report</Heading>\r\n\r\n                        <Text style={styles.text}>Hello {userName},</Text>\r\n                        <Text style={styles.text}>\r\n                            Here&rsquo;s your financial summary for {data?.month}:\r\n                        </Text>\r\n\r\n                        {/* Main Stats */}\r\n                        <Section style={styles.statsContainer}>\r\n                            <div style={styles.stat}>\r\n                                <Text style={styles.text}>Total Income</Text>\r\n                                <Text style={styles.heading}>${data?.stats.totalIncome}</Text>\r\n                            </div>\r\n                            <div style={styles.stat}>\r\n                                <Text style={styles.text}>Total Expenses</Text>\r\n                                <Text style={styles.heading}>${data?.stats.totalExpenses}</Text>\r\n                            </div>\r\n                            <div style={styles.stat}>\r\n                                <Text style={styles.text}>Net</Text>\r\n                                <Text style={styles.heading}>\r\n                                    ${data?.stats.totalIncome - data?.stats.totalExpenses}\r\n                                </Text>\r\n                            </div>\r\n                        </Section>\r\n\r\n                        {/* Category Breakdown */}\r\n                        {data?.stats?.byCategory && (\r\n                            <Section style={styles.section}>\r\n                                <Heading style={styles.heading}>Expenses by Category</Heading>\r\n                                {Object.entries(data?.stats.byCategory).map(\r\n                                    ([category, amount]) => (\r\n                                        <div key={category} style={styles.row}>\r\n                                            <Text style={styles.text}>{category}</Text>\r\n                                            <Text style={styles.text}>${amount}</Text>\r\n                                        </div>\r\n                                    )\r\n                                )}\r\n                            </Section>\r\n                        )}\r\n\r\n                        {/* AI Insights */}\r\n                        {data?.insights && (\r\n                            <Section style={styles.section}>\r\n                                <Heading style={styles.heading}>Welth Insights</Heading>\r\n                                {data.insights.map((insight, index) => (\r\n                                    <Text key={index} style={styles.text}>\r\n                                        â€¢ {insight}\r\n                                    </Text>\r\n                                ))}\r\n                            </Section>\r\n                        )}\r\n\r\n                        <Text style={styles.footer}>\r\n                            Thank you for using Welth. Keep tracking your finances for better\r\n                            financial health!\r\n                        </Text>\r\n                    </Container>\r\n                </Body>\r\n            </Html>\r\n        );\r\n    }\r\n\r\n    if (type === \"budget-alert\") {\r\n        return (\r\n            <Html>\r\n                <Head />\r\n                <Preview>Budget Alert</Preview>\r\n                <Body style={styles.body}>\r\n                    <Container style={styles.container}>\r\n                        <Heading style={styles.title}>Budget Alert</Heading>\r\n                        <Text style={styles.text}>Hello {userName},</Text>\r\n                        <Text style={styles.text}>\r\n                            You&rsquo;ve used {data?.percentageUsed.toFixed(1)}% of your\r\n                            monthly budget.\r\n                        </Text>\r\n                        <Section style={styles.statsContainer}>\r\n                            <div style={styles.stat}>\r\n                                <Text style={styles.text}>Budget Amount</Text>\r\n                                <Text style={styles.heading}>${data?.budgetAmount}</Text>\r\n                            </div>\r\n                            <div style={styles.stat}>\r\n                                <Text style={styles.text}>Spent So Far</Text>\r\n                                <Text style={styles.heading}>${data?.totalExpenses}</Text>\r\n                            </div>\r\n                            <div style={styles.stat}>\r\n                                <Text style={styles.text}>Remaining</Text>\r\n                                <Text style={styles.heading}>\r\n                                    ${data?.budgetAmount - data?.totalExpenses}\r\n                                </Text>\r\n                            </div>\r\n                        </Section>\r\n                    </Container>\r\n                </Body>\r\n            </Html>\r\n        );\r\n    }\r\n}\r\n\r\nconst styles = {\r\n    body: {\r\n        backgroundColor: \"#f6f9fc\",\r\n        fontFamily: \"-apple-system, sans-serif\",\r\n    },\r\n    container: {\r\n        backgroundColor: \"#ffffff\",\r\n        margin: \"0 auto\",\r\n        padding: \"20px\",\r\n        borderRadius: \"5px\",\r\n        boxShadow: \"0 2px 4px rgba(0, 0, 0, 0.1)\",\r\n    },\r\n    title: {\r\n        color: \"#1f2937\",\r\n        fontSize: \"32px\",\r\n        fontWeight: \"bold\",\r\n        textAlign: \"center\",\r\n        margin: \"0 0 20px\",\r\n    },\r\n    heading: {\r\n        color: \"#1f2937\",\r\n        fontSize: \"20px\",\r\n        fontWeight: \"600\",\r\n        margin: \"0 0 16px\",\r\n    },\r\n    text: {\r\n        color: \"#4b5563\",\r\n        fontSize: \"16px\",\r\n        margin: \"0 0 16px\",\r\n    },\r\n    section: {\r\n        marginTop: \"32px\",\r\n        padding: \"20px\",\r\n        backgroundColor: \"#f9fafb\",\r\n        borderRadius: \"5px\",\r\n        border: \"1px solid #e5e7eb\",\r\n    },\r\n    statsContainer: {\r\n        margin: \"32px 0\",\r\n        padding: \"20px\",\r\n        backgroundColor: \"#f9fafb\",\r\n        borderRadius: \"5px\",\r\n    },\r\n    stat: {\r\n        marginBottom: \"16px\",\r\n        padding: \"12px\",\r\n        backgroundColor: \"#fff\",\r\n        borderRadius: \"4px\",\r\n        boxShadow: \"0 1px 2px rgba(0, 0, 0, 0.05)\",\r\n    },\r\n    row: {\r\n        display: \"flex\",\r\n        justifyContent: \"space-between\",\r\n        padding: \"12px 0\",\r\n        borderBottom: \"1px solid #e5e7eb\",\r\n    },\r\n    footer: {\r\n        color: \"#6b7280\",\r\n        fontSize: \"14px\",\r\n        textAlign: \"center\",\r\n        marginTop: \"32px\",\r\n        paddingTop: \"16px\",\r\n        borderTop: \"1px solid #e5e7eb\",\r\n    },\r\n};"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 672, "column": 0}, "map": {"version":3,"sources":["file:///D:/wealth/actions/send-email.js"],"sourcesContent":["\"use server\";\r\n\r\nimport { Resend } from \"resend\";\r\n\r\nexport async function sendEmail({ to, subject, react }) {\r\n    const resend = new Resend(process.env.RESEND_API_KEY || \"\");\r\n\r\n    try {\r\n        const data = await resend.emails.send({\r\n            from: \"Finance App <onboarding@resend.dev>\",\r\n            to,\r\n            subject,\r\n            react,\r\n        });\r\n\r\n        return { success: true, data };\r\n    } catch (error) {\r\n        console.error(\"Failed to send email:\", error);\r\n        return { success: false, error };\r\n    }\r\n}"],"names":[],"mappings":";;;;;AAEA;;;;;AAEO,eAAe,UAAU,EAAE,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE;IAClD,MAAM,SAAS,IAAI,0IAAA,CAAA,SAAM,CAAC,QAAQ,GAAG,CAAC,cAAc,IAAI;IAExD,IAAI;QACA,MAAM,OAAO,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC;YAClC,MAAM;YACN;YACA;YACA;QACJ;QAEA,OAAO;YAAE,SAAS;YAAM;QAAK;IACjC,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO;YAAE,SAAS;YAAO;QAAM;IACnC;AACJ;;;IAhBsB;;AAAA,iPAAA","debugId":null}},
    {"offset": {"line": 714, "column": 0}, "map": {"version":3,"sources":["file:///D:/wealth/lib/inngest/functions.js"],"sourcesContent":["import { inngest } from \"./client\";\r\nimport { db } from \"@/lib/prisma\";\r\nimport EmailTemplate from \"@/emails/templates\";\r\nimport { sendEmail } from \"@/actions/send-email\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\n\r\n// 1. Recurring Transaction Processing with Throttling\r\nexport const processRecurringTransaction = inngest.createFunction(\r\n    {\r\n        id: \"process-recurring-transaction\",\r\n        name: \"Process Recurring Transaction\",\r\n        throttle: {\r\n            limit: 10, // Process 10 transactions\r\n            period: \"1m\", // per minute\r\n            key: \"event.data.userId\", // Throttle per user\r\n        },\r\n    },\r\n    { event: \"transaction.recurring.process\" },\r\n    async ({ event, step }) => {\r\n        // Validate event data\r\n        if (!event?.data?.transactionId || !event?.data?.userId) {\r\n            console.error(\"Invalid event data:\", event);\r\n            return { error: \"Missing required event data\" };\r\n        }\r\n\r\n        await step.run(\"process-transaction\", async () => {\r\n            const transaction = await db.transaction.findUnique({\r\n                where: {\r\n                    id: event.data.transactionId,\r\n                    userId: event.data.userId,\r\n                },\r\n                include: {\r\n                    account: true,\r\n                },\r\n            });\r\n\r\n            if (!transaction || !isTransactionDue(transaction)) return;\r\n\r\n            // Create new transaction and update account balance in a transaction\r\n            await db.$transaction(async (tx) => {\r\n                // Create new transaction\r\n                await tx.transaction.create({\r\n                    data: {\r\n                        type: transaction.type,\r\n                        amount: transaction.amount,\r\n                        description: `${transaction.description} (Recurring)`,\r\n                        date: new Date(),\r\n                        category: transaction.category,\r\n                        userId: transaction.userId,\r\n                        accountId: transaction.accountId,\r\n                        isRecurring: false,\r\n                    },\r\n                });\r\n\r\n                // Update account balance\r\n                const balanceChange =\r\n                    transaction.type === \"EXPENSE\"\r\n                        ? -transaction.amount.toNumber()\r\n                        : transaction.amount.toNumber();\r\n\r\n                await tx.account.update({\r\n                    where: { id: transaction.accountId },\r\n                    data: { balance: { increment: balanceChange } },\r\n                });\r\n\r\n                // Update last processed date and next recurring date\r\n                await tx.transaction.update({\r\n                    where: { id: transaction.id },\r\n                    data: {\r\n                        lastProcessed: new Date(),\r\n                        nextRecurringDate: calculateNextRecurringDate(\r\n                            new Date(),\r\n                            transaction.recurringInterval\r\n                        ),\r\n                    },\r\n                });\r\n            });\r\n        });\r\n    }\r\n);\r\n\r\n// Trigger recurring transactions with batching\r\nexport const triggerRecurringTransactions = inngest.createFunction(\r\n    {\r\n        id: \"trigger-recurring-transactions\", // Unique ID,\r\n        name: \"Trigger Recurring Transactions\",\r\n    },\r\n    { cron: \"0 0 * * *\" }, // Daily at midnight\r\n    async ({ step }) => {\r\n        const recurringTransactions = await step.run(\r\n            \"fetch-recurring-transactions\",\r\n            async () => {\r\n                return await db.transaction.findMany({\r\n                    where: {\r\n                        isRecurring: true,\r\n                        status: \"COMPLETED\",\r\n                        OR: [\r\n                            { lastProcessed: null },\r\n                            {\r\n                                nextRecurringDate: {\r\n                                    lte: new Date(),\r\n                                },\r\n                            },\r\n                        ],\r\n                    },\r\n                });\r\n            }\r\n        );\r\n\r\n        // Send event for each recurring transaction in batches\r\n        if (recurringTransactions.length > 0) {\r\n            const events = recurringTransactions.map((transaction) => ({\r\n                name: \"transaction.recurring.process\",\r\n                data: {\r\n                    transactionId: transaction.id,\r\n                    userId: transaction.userId,\r\n                },\r\n            }));\r\n\r\n            // Send events directly using inngest.send()\r\n            await inngest.send(events);\r\n        }\r\n\r\n        return { triggered: recurringTransactions.length };\r\n    }\r\n);\r\n\r\n// 2. Monthly Report Generation\r\nasync function generateFinancialInsights(stats, month) {\r\n    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);\r\n    const model = genAI.getGenerativeModel({ model: \"gemini-1.5-flash\" });\r\n\r\n    const prompt = `\r\n    Analyze this financial data and provide 3 concise, actionable insights.\r\n    Focus on spending patterns and practical advice.\r\n    Keep it friendly and conversational.\r\n\r\n    Financial Data for ${month}:\r\n    - Total Income: $${stats.totalIncome}\r\n    - Total Expenses: $${stats.totalExpenses}\r\n    - Net Income: $${stats.totalIncome - stats.totalExpenses}\r\n    - Expense Categories: ${Object.entries(stats.byCategory)\r\n            .map(([category, amount]) => `${category}: $${amount}`)\r\n            .join(\", \")}\r\n\r\n    Format the response as a JSON array of strings, like this:\r\n    [\"insight 1\", \"insight 2\", \"insight 3\"]\r\n  `;\r\n\r\n    try {\r\n        const result = await model.generateContent(prompt);\r\n        const response = result.response;\r\n        const text = response.text();\r\n        const cleanedText = text.replace(/```(?:json)?\\n?/g, \"\").trim();\r\n\r\n        return JSON.parse(cleanedText);\r\n    } catch (error) {\r\n        console.error(\"Error generating insights:\", error);\r\n        return [\r\n            \"Your highest expense category this month might need attention.\",\r\n            \"Consider setting up a budget for better financial management.\",\r\n            \"Track your recurring expenses to identify potential savings.\",\r\n        ];\r\n    }\r\n}\r\n\r\nexport const generateMonthlyReports = inngest.createFunction(\r\n    {\r\n        id: \"generate-monthly-reports\",\r\n        name: \"Generate Monthly Reports\",\r\n    },\r\n    { cron: \"0 0 1 * *\" }, // First day of each month\r\n    async ({ step }) => {\r\n        const users = await step.run(\"fetch-users\", async () => {\r\n            return await db.user.findMany({\r\n                include: { accounts: true },\r\n            });\r\n        });\r\n\r\n        for (const user of users) {\r\n            await step.run(`generate-report-${user.id}`, async () => {\r\n                const lastMonth = new Date();\r\n                lastMonth.setMonth(lastMonth.getMonth() - 1);\r\n\r\n                const stats = await getMonthlyStats(user.id, lastMonth);\r\n                const monthName = lastMonth.toLocaleString(\"default\", {\r\n                    month: \"long\",\r\n                });\r\n\r\n                // Generate AI insights\r\n                const insights = await generateFinancialInsights(stats, monthName);\r\n\r\n                await sendEmail({\r\n                    to: user.email,\r\n                    subject: `Your Monthly Financial Report - ${monthName}`,\r\n                    react: EmailTemplate({\r\n                        userName: user.name,\r\n                        type: \"monthly-report\",\r\n                        data: {\r\n                            stats,\r\n                            month: monthName,\r\n                            insights,\r\n                        },\r\n                    }),\r\n                });\r\n            });\r\n        }\r\n\r\n        return { processed: users.length };\r\n    }\r\n);\r\n\r\n// 3. Budget Alerts with Event Batching\r\nexport const checkBudgetAlerts = inngest.createFunction(\r\n    { name: \"Check Budget Alerts\" },\r\n    { cron: \"0 */6 * * *\" }, // Every 6 hours\r\n    async ({ step }) => {\r\n        const budgets = await step.run(\"fetch-budgets\", async () => {\r\n            return await db.budget.findMany({\r\n                include: {\r\n                    user: {\r\n                        include: {\r\n                            accounts: {\r\n                                where: {\r\n                                    isDefault: true,\r\n                                },\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n            });\r\n        });\r\n\r\n        for (const budget of budgets) {\r\n            const defaultAccount = budget.user.accounts[0];\r\n            if (!defaultAccount) continue; // Skip if no default account\r\n\r\n            await step.run(`check-budget-${budget.id}`, async () => {\r\n                const startDate = new Date();\r\n                startDate.setDate(1); // Start of current month\r\n\r\n                // Calculate total expenses for the default account only\r\n                const expenses = await db.transaction.aggregate({\r\n                    where: {\r\n                        userId: budget.userId,\r\n                        accountId: defaultAccount.id, // Only consider default account\r\n                        type: \"EXPENSE\",\r\n                        date: {\r\n                            gte: startDate,\r\n                        },\r\n                    },\r\n                    _sum: {\r\n                        amount: true,\r\n                    },\r\n                });\r\n\r\n                const totalExpenses = expenses._sum.amount?.toNumber() || 0;\r\n                const budgetAmount = budget.amount;\r\n                const percentageUsed = (totalExpenses / budgetAmount) * 100;\r\n\r\n                // Check if we should send an alert\r\n                if (\r\n                    percentageUsed >= 80 && // Default threshold of 80%\r\n                    (!budget.lastAlertSent ||\r\n                        isNewMonth(new Date(budget.lastAlertSent), new Date()))\r\n                ) {\r\n                    // sending email\r\n                    await sendEmail({\r\n                        to: budget.user.email,\r\n                        subject: `Budget Alert for ${defaultAccount.name}`,\r\n                        react: EmailTemplate({\r\n                            userName: budget.user.name,\r\n                            type: \"budget-alert\",\r\n                            data: {\r\n                                percentageUsed,\r\n                                budgetAmount: parseInt(budgetAmount).toFixed(1),\r\n                                totalExpenses: parseInt(totalExpenses).toFixed(1),\r\n                                accountName: defaultAccount.name,\r\n                            },\r\n                        }),\r\n                    });\r\n\r\n                    // Update last alert sent\r\n                    await db.budget.update({\r\n                        where: { id: budget.id },\r\n                        data: { lastAlertSent: new Date() },\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    }\r\n);\r\n\r\nfunction isNewMonth(lastAlertDate, currentDate) {\r\n    return (\r\n        lastAlertDate.getMonth() !== currentDate.getMonth() ||\r\n        lastAlertDate.getFullYear() !== currentDate.getFullYear()\r\n    );\r\n}\r\n\r\n// Utility functions\r\nfunction isTransactionDue(transaction) {\r\n    // If no lastProcessed date, transaction is due\r\n    if (!transaction.lastProcessed) return true;\r\n\r\n    const today = new Date();\r\n    const nextDue = new Date(transaction.nextRecurringDate);\r\n\r\n    // Compare with nextDue date\r\n    return nextDue <= today;\r\n}\r\n\r\nfunction calculateNextRecurringDate(date, interval) {\r\n    const next = new Date(date);\r\n    switch (interval) {\r\n        case \"DAILY\":\r\n            next.setDate(next.getDate() + 1);\r\n            break;\r\n        case \"WEEKLY\":\r\n            next.setDate(next.getDate() + 7);\r\n            break;\r\n        case \"MONTHLY\":\r\n            next.setMonth(next.getMonth() + 1);\r\n            break;\r\n        case \"YEARLY\":\r\n            next.setFullYear(next.getFullYear() + 1);\r\n            break;\r\n    }\r\n    return next;\r\n}\r\n\r\nasync function getMonthlyStats(userId, month) {\r\n    const startDate = new Date(month.getFullYear(), month.getMonth(), 1);\r\n    const endDate = new Date(month.getFullYear(), month.getMonth() + 1, 0);\r\n\r\n    const transactions = await db.transaction.findMany({\r\n        where: {\r\n            userId,\r\n            date: {\r\n                gte: startDate,\r\n                lte: endDate,\r\n            },\r\n        },\r\n    });\r\n\r\n    return transactions.reduce(\r\n        (stats, t) => {\r\n            const amount = t.amount.toNumber();\r\n            if (t.type === \"EXPENSE\") {\r\n                stats.totalExpenses += amount;\r\n                stats.byCategory[t.category] =\r\n                    (stats.byCategory[t.category] || 0) + amount;\r\n            } else {\r\n                stats.totalIncome += amount;\r\n            }\r\n            return stats;\r\n        },\r\n        {\r\n            totalExpenses: 0,\r\n            totalIncome: 0,\r\n            byCategory: {},\r\n            transactionCount: transactions.length,\r\n        }\r\n    );\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1054, "column": 0}, "map": {"version":3,"sources":["file:///D:/wealth/app/api/inngest/route.js"],"sourcesContent":["import { serve } from \"inngest/next\";\r\n\r\nimport { inngest } from \"@/lib/inngest/client\";\r\nimport {\r\n  checkBudgetAlerts,\r\n  generateMonthlyReports,\r\n  processRecurringTransaction,\r\n  triggerRecurringTransactions,\r\n} from \"@/lib/inngest/functions\";\r\n\r\nexport const { GET, POST, PUT } = serve({\r\n  client: inngest,\r\n  functions: [\r\n    processRecurringTransaction,\r\n    triggerRecurringTransactions,\r\n    generateMonthlyReports,\r\n    checkBudgetAlerts,\r\n  ],\r\n});"],"names":[],"mappings":";;;;;AAAA;AAEA;AACA;;;;AAOO,MAAM,EAAE,GAAG,EAAE,IAAI,EAAE,GAAG,EAAE,GAAG,CAAA,GAAA,iIAAA,CAAA,QAAK,AAAD,EAAE;IACtC,QAAQ,0HAAA,CAAA,UAAO;IACf,WAAW;QACT,6HAAA,CAAA,8BAA2B;QAC3B,6HAAA,CAAA,+BAA4B;QAC5B,6HAAA,CAAA,yBAAsB;QACtB,6HAAA,CAAA,oBAAiB;KAClB;AACH","debugId":null}}]
}